<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />

    <link
      rel="stylesheet"
      type="text/css"
      href="//fonts.googleapis.com/css?family=Ubuntu"
    />

    <!-- Style for the header/navbar -->
    <link
      rel="stylesheet"
      type="text/css"
      href="../../components/header/header.css"
    />

    <!-- Script for the header/navbar -->
    <script src="../../components/header/header.js"></script>

    <!-- Style fort the resources -->
    <link rel="stylesheet" type="text/css" href="explore.css" />

    <!-- Script for the resources -->
    <script src="explore.js"></script>

    <!-- Script for the community -->
    <script src="../../shared/utils.js"></script>

    <!-- JQuery -->
    <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>

    <!-- Lunr -->
    <script src="https://unpkg.com/lunr/lunr.js"></script>

    <!-- General styles -->
    <link
      rel="stylesheet"
      type="text/css"
      href="../../shared/styles/styles.css"
    />

    <title>Explore page</title>
  </head>
  <body>
    <div id="website-navbar" class="website-navbar"></div>
    <div id="explore-page" class="explore-page "></div>
    <div class="dir-component">
      <div class="dir-tree">
        <div class="dir-column">
          <ul class="bullet-folder-closed column-0"></ul>
        </div>
        <div class="dir-column">
          <ul class="bullet-folder-closed column-1"></ul>
        </div>
        <div class="dir-column">
          <ul class="bullet-folder-closed column-2"></ul>
        </div>
        <div class="dir-column">
          <ul class="bullet-folder-closed column-3"></ul>
        </div>
        <div class="dir-column">
          <ul class="bullet-folder-closed column-4"></ul>
        </div>
      </div>
      <div class="dir-tree-detail">
        <h2>More info -></h2>
        <h2 class="details-title"></h2>
        <p class="details-content"></p>
      </div>
    </div>
    <script>
      const EXPLORE_DEST = '#explore-page';
      const NAVBAR_DEST = '#website-navbar';

      let searchData = { index: null, documents: null };
      UtilsModule.loadIndex(searchData);

      $(window).on('load', function() {
        const queryFun = () => {
          HeaderModule.queryFunction(searchData);
        };

        HeaderModule.loadNavbar(NAVBAR_DEST, () => {
          HeaderModule.searchOnClick(queryFun);
        });

        ExploreModule.loadExplorePage(EXPLORE_DEST, () => {
          UtilsModule.editSrc(undefined, '../../');

          getDirs('./dir-content', 'entry-point.html', 0);
        });
      });

      function getDirs(dir, entryPoint, lvl) {
        let aux = $("<div id='aux'></div>");

        aux.load(`${dir}/${entryPoint} #content`, function() {
          aux.find('.links-to-files a').each(function(index, el) {
            let href = $(el).attr('href');
            let aux2 = $("<div id='aux2'></div>");

            aux2.load(`${dir}/${href} #content`, getDirInfo(aux2, el, lvl));
          });
        });
      }

      function getDirInfo(aux2, el, lvl) {
        return () => {
          let dir = aux2.find('.directory');
          let links = aux2.find('.links-to-files');
          let title = dir.find('h2').text();
          let text = getText(dir);
          let listItem = getListItem(title, el, lvl + 1);

          if (!links.length) {
            let afterClick = () => getDetails(title, text);
            listItem = getListItem(title, el, lvl + 1, afterClick);
            listItem.attr('class', 'bullet-file');
          }

          $('.column-' + (lvl + 1)).append(listItem);
        };
      }

      function getText(dir) {
        return dir
          .find('p')
          .map((index, el) => $(el).text() + '<br/>')
          .get()
          .join('');
      }

      function getDetails(title, content) {
        $('.dir-component .details-title').html(title);
        $('.dir-component .details-content').html(content);
      }

      function getListItem(text, el, lvlDest, afterClick = () => {}) {
        function clickHandler() {
          $(this)
            .toggleClass('bullet-folder-open')
            .siblings()
            .removeClass('bullet-folder-open');

          clearDir(lvlDest + 1);
          afterClick();
          getDirs('./dir-content', $(el).attr('href'), lvlDest);
        }

        let listItem = $(`<li>${text}</li>`).click(clickHandler);
        return listItem;
      }

      function clearDir(fromLvl = 0) {
        let howManyCols = $('[class*="column-"]').length;
        for (let i = fromLvl; i < howManyCols; i++) {
          $(`.column-${i}`).empty();
        }
        $('.dir-component .details-title').empty();
        $('.dir-component .details-content').empty();
      }
    </script>
  </body>
</html>
