<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Search results</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      rel="stylesheet"
      type="text/css"
      href="//fonts.googleapis.com/css?family=Ubuntu"
    />

    <!-- Style fort the cards -->
    <link rel="stylesheet" type="text/css" href="search-results.css" />

    <!-- Script for the community -->
    <script src="../../shared/utils.js"></script>

    <!-- JQuery -->
    <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>

    <!-- Lunr -->
    <script src="https://unpkg.com/lunr/lunr.js"></script>
  </head>
  <body>
    <div id="search-results" class="search-results"></div>
    <script>
      let searchData = { index: null, documents: null };
      UtilsModule.loadIndex(searchData);

      function wordsHtml(words, snippetsMap) {
        const wordToSnippet = (word) => {
          return `
              <div class="snippet">
                <div class="title">
                  <strong>${word}:</strong>
                </div>
                <ul>
                ${snippetsMap[word].map(
                  (snippet) => '<li class="text">' + snippet + '</li>',
                )}
                </ul>
              </div>
              <hr/>
              `;
        };

        return words.map((word) => wordToSnippet(word)).join('');
      }

      function textSnippets(doc, metadataMap) {
        const metadataKeys = Object.keys(metadataMap);

        const whereData = (key) => metadataMap[key];
        const whereKeys = (key) => Object.keys(metadataMap[key]);

        const snippetsMap = {};
        metadataKeys.forEach((key) => {
          snippets = [];

          whereK = whereKeys(key);
          whereK.forEach((k) => {
            const text = doc[k];
            const positions = whereData(key)[k].position;
            const wordStart = positions[0][0];
            const wordLen = positions[0][1];

            const lowerLimit = Math.max(wordStart - 80, 0);
            const upperLimit = Math.min(wordStart + 80, text.length - 1);
            let highlighted =
              text.substring(0, wordStart) +
              `<mark>${text.substring(wordStart, wordStart + wordLen)}</mark>` +
              text.substring(wordStart + wordLen, text.length);

            const textSnippet = `...${highlighted.substring(
              lowerLimit,
              upperLimit,
            )}...`;

            snippets.push(textSnippet);
          });

          snippetsMap[key] = snippets;
        });

        return snippetsMap;
      }

      function gotoArticle(destArticle) {
        location.href =
          '/website/pages/docs/page-docs.html' +
          '?q=' +
          destArticle
            .trim()
            .replace('./devonfw-guide/', '../../../')
            .replace(/\.asciidoc$/, '.html');
      }

      $(window).on('load', function() {
        const search = function() {
          let query = UtilsModule.getParametersFromUrl('search');
          let queryRes = searchData.index.search(query);
          const findById = (id, docs) => {
            return docs.find((doc) => '' + doc.id == '' + id);
          };

          const results = queryRes
            .map((queryResult, i) => {
              if (i > 10) return '';

              const doc = findById(queryResult.ref, searchData.documents);
              const metadataMap = queryResult.matchData.metadata;
              const metadataKeys = Object.keys(metadataMap);
              const snippetsMap = textSnippets(doc, metadataMap);

              return `
                <div class="result-card">
                  <h2 class="sr-title">
                    ${doc.title}
                  </h2>
                  <div class="sr-content">
                    ${queryResult.ref}
                  </div>
                    ${wordsHtml(metadataKeys, snippetsMap)}
                  <div class="docs-btn">
                    <button onclick="gotoArticle('${
                      queryResult.ref
                    }')">Go to docs</button>
                  </div>
                </div>
                `;
            })
            .join('');

          const resBox = `${results}`;

          $('#search-results').html(resBox);
        };

        function searchAfterIdx() {
          if (!searchData.index) {
            console.log('waiting');
            setTimeout(searchAfterIdx, 200);
          } else {
            search();
          }
        }

        searchAfterIdx();
      });
    </script>
  </body>
</html>
