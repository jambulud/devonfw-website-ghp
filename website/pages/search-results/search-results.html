<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Search results</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      rel="stylesheet"
      type="text/css"
      href="//fonts.googleapis.com/css?family=Ubuntu"
    />

    <!-- Style fort the cards -->
    <link rel="stylesheet" type="text/css" href="search-results.css" />

    <!-- Script for the community -->
    <script src="../../shared/utils.js"></script>

    <!-- JQuery -->
    <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>

    <!-- Lunr -->
    <script src="https://unpkg.com/lunr/lunr.js"></script>
  </head>
  <body>
    <div id="search-results" class="search-results"></div>
    <script>
      let searchData = { index: null, documents: null };
      UtilsModule.loadIndex(searchData);

      function gotoArticle(destArticle) {
        location.href =
          '/website/pages/docs/page-docs.html' +
          '?q=' +
          destArticle
            .trim()
            .replace('./devonfw-guide/', '../../../')
            .replace(/\.asciidoc$/, '.html');
      }

      $(window).on('load', function() {
        const search = function() {
          let query = UtilsModule.getParametersFromUrl('search');
          let queryRes = searchData.index.search(query);
          const findById = (id, docs) => {
            return docs.find((doc) => '' + doc.id == '' + id);
          };

          const results = queryRes
            .map((queryResult, i) => {
              if (i > 10) return '';

              const doc = findById(queryResult.ref, searchData.documents);
              const metadataMap = queryResult.matchData.metadata;
              const metadataKeys = Object.keys(metadataMap);

              textSnippetsMap = getSnippets(metadataMap, 200, doc.body);
              console.log('HELLO');
              let snippetHtml = '';

              let maxLen = -1;
              for (let snippet in textSnippetsMap) {
                nWordsInSnippet = textSnippetsMap[snippet].length;
                if (nWordsInSnippet > maxLen) {
                  maxLen = nWordsInSnippet;
                  snippetHtml = `
                  <div class="snippet">
                    <div class="title">
                      <strong>${
                        textSnippetsMap[snippet]
                      }</strong><span class="see-more">&nbsp;&nbsp;See more</span>
                    </div>
                    <div class="text">&quot;${snippet.trim()}(...)&quot;</div>  
                  </div>`;
                }
              }

              console.log('WORLDS');

              return `
                <div class="result-card">
                  <h2 class="sr-title">
                    ${doc.title}
                  </h2>
                    ${snippetHtml}
                  <div class="docs-btn">

                    <button onclick="gotoArticle('${queryResult.ref}')">Go to docs</button>
                  </div>
                </div>
                `;
            })
            .join('');

          const resBox = `${results}`;

          $('#search-results').html(resBox);
        };

        function searchAfterIdx() {
          if (!searchData.index) {
            console.log('waiting');
            setTimeout(searchAfterIdx, 200);
          } else {
            search();
          }
        }

        searchAfterIdx();
      });

      function removeFromIndex(occurrencesMap, start, end) {
        for (let key in occurrencesMap) {
          let occs = occurrencesMap[key].body.position;
          let filtered = occs.filter((occ) => occ[0] < start || occ[0] > end);
          occurrencesMap[key].body.position = filtered;
        }

        return occurrencesMap;
      }

      function getSnippets(occMap, range, text) {
        let occurrencesMap = JSON.parse(JSON.stringify(occMap));
        let occurrencesKeys = Object.keys(occurrencesMap);
        let snippetStore = {};

        // for each word in the search query
        for (let i = 0; i < occurrencesKeys.length; i++) {
          let key = occurrencesKeys[i];
          let ocurrences = occurrencesMap[key].body.position;

          // for each ocurrence of a word
          for (let j = 0; j < ocurrences.length; j++) {
            let ocurrence = ocurrences[j][0];
            let start = ocurrence - range;
            let end = ocurrence + range;
            let txtWindow = text.substring(start, end);

            let searchUntil = occurrencesKeys.length;

            let regexpWords = [];

            // Decrement the words searched
            while (searchUntil > i) {
              // Search how many words from the query are in the window
              regexpWords = occurrencesKeys.slice(i, searchUntil);
              let wordsRe = new RegExp(
                '.*' + regexpWords.join('(.|\\n)*') + '.*',
                'igm',
              );

              // Save if the snippet contains the words
              // in ocurrencesKeys[i] ... ocurrencesKeys[searchUntil]
              let containsTheWords = txtWindow.match(wordsRe) ? true : false;
              if (containsTheWords) {
                for (let w = 0; w < regexpWords.length; w++) {
                  txtWindow = txtWindow.replace(
                    new RegExp(regexpWords[w], 'ig'),
                    `<span class="marked-word">$&</span>`,
                  );
                }
                snippetStore[txtWindow] = regexpWords;
              }

              searchUntil--;

              // If all the words are contained
              if (
                containsTheWords &&
                regexpWords.length == occurrencesKeys.length
              ) {
                break;
              }
            }

            // Remove found ocurrences from the index. "Normalize".
            removeFromIndex(occurrencesMap, start, end);
          }
        }

        return snippetStore;
      }
    </script>
  </body>
</html>
